#!/usr/bin/env python
#
# syncit
#
# Provides a quick way of sending a project to a
# specific location on a remote machine.
#
# I use this with Vagrant in my day-to-day work.
#
# Recursively looks upward for .syncit file.
# Once the config is located, it pulls the upload 
# location from the file and rsyncs the project 
# contents to that location.
#
# It's a good idea to add the config to your .gitignore.
#
# Example usage:
#   syncit
#
# Example .syncit file:
#   host:/webroot/project/

import os
import os.path
import subprocess

def sync_to(source, dest):
    subprocess.call('cd %s && rsync -vPzrtl --delete --exclude=".git" $(pwd)/* %s' % (source, dest), shell=True)

def config_path(file_name, path='.'):
    path  = os.path.abspath(path)
    files = [x for x in os.listdir(path) if os.path.isfile("%s/%s" % (path, x))]

    if file_name in files:
        return os.path.dirname("%s/%s" % (path, file_name))
    elif path == '/':
        return None
    else:
        return config_path(file_name, os.path.join(path, os.pardir))

if __name__ == "__main__":
    config_dir = config_path(".syncit")

    if config_dir:
        try:
            f        = open(config_dir + "/.syncit")
            location = f.readline()

            sync_to(config_dir, location)

        except IOError as e:
            print 'No .syncit file found.'
            exit(1)
    else:
        print 'No .syncit file found.'
        exit(1)
